<div [class]="containerClasses">
  
  <!-- Skeleton loader mientras carga -->
  <p-skeleton 
    *ngIf="loading || (isLoading && autoLoad)"
    [shape]="isCircle ? 'circle' : 'square'"
    [size]="size === 'xlarge' ? '96px' : size === 'large' ? '64px' : '48px'">
  </p-skeleton>

  <!-- Avatar principal -->
  <p-avatar
    *ngIf="!loading && !(isLoading && autoLoad)"
    [image]="hasImage ? (avatarUrl || undefined) : undefined"
    [size]="size"
    [shape]="shape"
    [style]="avatarStyles"
    [pTooltip]="showTooltip ? tooltipText : undefined"
    tooltipPosition="top"
    [class]="contextClass"
    (click)="onAvatarClick()"
    (imageError)="onImageError()">
    <!-- Material Symbol icon fallback when no image -->
    <span *ngIf="!hasImage" class="material-symbols-outlined avatar-fallback-icon">
      {{ getFallbackIcon() }}
    </span>
  </p-avatar>

  <!-- Botón de editar (superpuesto) -->
  <button
    *ngIf="showUploadButton && !loading && !(isLoading && autoLoad)"
    type="button"
    class="edit-button"
    pButton
    icon="fas fa-pen"
    [size]="size === 'xlarge' ? 'small' : 'small'"
    severity="secondary"
    [rounded]="true"
    pTooltip="Editar imagen"
    tooltipPosition="top"
    aria-label="Editar imagen"
    (click)="onEditClick($event)">
  </button>

  <!-- Indicator de imagen nueva o estado -->
  <div
    *ngIf="avatar && !hasImage"
    class="status-indicator error"
    pTooltip="Error al cargar imagen"
    tooltipPosition="top">
    <i class="fas fa-triangle-exclamation" aria-hidden="true"></i>
  </div>

  <!-- Loading indicator pequeño para carga automática -->
  <div
    *ngIf="isLoading && autoLoad && !loading"
    class="loading-indicator"
    pTooltip="Cargando imagen..."
    tooltipPosition="top">
    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
  </div>

</div>

<!-- Modal de subida de imagen -->
<orb-image-upload-modal
  [(visible)]="showModal"
  [entityType]="modalEntityType"
  [entityId]="entity.id"
  [currentImage]="avatar"
  [modalTitle]="modalTitle"
  (imageUploaded)="onModalImageUploaded($event)"
  (imageDeleted)="onModalImageDeleted()"
  (uploadError)="onUploadError($event)">
</orb-image-upload-modal>