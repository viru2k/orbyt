<!-- Breadcrumb superior -->
<orb-breadcrumb [items]="breadcrumbItems"></orb-breadcrumb>

<orb-toolbar>
  <div body></div>
  <div footer>
    <orb-button label="Nuevo Usuario" (click)="openUserEditModal()" />
  </div>
</orb-toolbar>

<orb-card>
  <div class="grid" orbBody>
    <orb-table
      [value]="(users$ | async) || []"
      [columns]="columns"
      [loading]="(loading$ | async) || false"
      [totalRecords]="(users$ | async)?.length || 0"
      [rows]="tableRows()"
      [first]="tableFirst()"
      [tableFeatures]="tableFeaturesConfig"
      [globalFilterFields]="['email', 'fullName']"
      [rowActions]="actions"
      dataKey="id"
      paginatorPosition="bottom"
      [rowsPerPageOptions]="[15, 30, 50]"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
    >
      <ng-template pTemplate="body" let-user let-columns="columns">
        <tr>
          <td *ngFor="let col of columns">
            <ng-container [ngSwitch]="col.field">
              
              <!-- Caso para la columna de perfil: avatar + información -->
              <ng-container *ngSwitchCase="'profile'">
                <div class="flex align-items-center gap-3">
                  <orb-entity-avatar
                    [entity]="user"
                    entityType="user"
                    size="normal"
                    shape="circle"
                    [showTooltip]="true"
                    context="table"
                    [autoLoad]="true">
                  </orb-entity-avatar>
                  <div class="user-info">
                    <div class="user-name font-medium text-900">{{ user.fullName }}</div>
                    <div class="user-email text-600 text-sm">{{ user.email }}</div>
                  </div>
                </div>
              </ng-container>
              
              <!-- Caso para la columna de roles: mostramos tags -->
              <ng-container *ngSwitchCase="'roles'">
                <div class="flex gap-1 flex-wrap">
                  <p-tag
                    *ngFor="let role of user.roles"
                    [value]="role.name"
                    severity="info"
                    [style]="{ 'font-size': '0.75rem', 'padding': '0.25rem 0.5rem' }">
                  </p-tag>
                  <span *ngIf="!user.roles || user.roles.length === 0" class="text-muted">Sin roles</span>
                </div>
              </ng-container>

              <!-- Caso para la columna de estado activo: mostramos badge -->
              <ng-container *ngSwitchCase="'active'">
                <span [ngClass]="user.active ? 'status-active' : 'status-inactive'">
                  {{ user.active ? 'Activo' : 'Inactivo' }}
                </span>
              </ng-container>

              <!-- Caso para la columna de admin: mostramos Sí/No -->
              <ng-container *ngSwitchCase="'isAdmin'">
                {{ user.isAdmin ? 'Sí' : 'No' }}
              </ng-container>

              <!-- Caso para la columna de acciones: dibujamos los botones -->
              <ng-container *ngSwitchCase="'actions'">
                <orb-actions-popover
                  [actions]="actions"
                  [itemData]="user">
                </orb-actions-popover>
              </ng-container>

              <!-- Caso por defecto para todas las demás columnas -->
              <ng-container *ngSwitchDefault>
                {{ user[col.field] }}
              </ng-container>
              
            </ng-container>
          </td>
        </tr>
      </ng-template>
    </orb-table>
  </div>
</orb-card>

<orb-dialog
  [visible]="displayUserEditModal()"
  [header]="isEditMode() ? 'Editar Usuario' : 'Nuevo Usuario'"
  size="lg"
  (onHide)="onUserFormCancel()"
>
  @if (displayUserEditModal()) {
    <app-user-edit-form
      [user]="userToEdit()"
      (saved)="onUserFormSaved()"
      (cancel)="onUserFormCancel()"
    >
    </app-user-edit-form>
  }
</orb-dialog>

<!-- Agenda Configuration Modal -->
<app-agenda-config-modal
  [visible]="displayAgendaConfigModal()"
  [professionalId]="selectedProfessionalId() ?? undefined"
  (close)="onAgendaConfigModalClose()"
>
</app-agenda-config-modal>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
