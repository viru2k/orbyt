<orb-main-header
  title="   Panel de Control"
  icon="fa fa-tachometer-alt"
  subtitle="Gestión integral de consultas e ingresos - {{ currentMonth }}"
>
</orb-main-header>
<div class="dashboard" *ngIf="!isLoading()">
  <!-- Metrics Grid usando sistema global -->
  <div class="metrics-grid">
    <!-- Ingresos Totales -->
    <div class="metric-card success">
      <div class="metric-content">
        <div class="metric-icon">
          <i class="fa fa-euro-sign"></i>
        </div>
        <div class="metric-details">
          <h3>{{ totalRevenue() | currency : 'EUR' : 'symbol' : '1.0-0' }}</h3>
          <span>Ingresos Totales</span>
          <small class="metric-trend positive">
            <i class="fa fa-arrow-up"></i> +{{ revenueGrowth() }}%
          </small>
        </div>
      </div>
    </div>

    <!-- Consultas Totales -->
    <div class="metric-card info">
      <div class="metric-content">
        <div class="metric-icon">
          <i class="fa fa-stethoscope"></i>
        </div>
        <div class="metric-details">
          <h3>{{ totalConsultations() }}</h3>
          <span>Consultas Totales</span>
          <small class="metric-trend positive">
            <i class="fa fa-arrow-up"></i> +{{ consultationGrowth() }}%
          </small>
        </div>
      </div>
    </div>

    <!-- Facturas Pendientes -->
    <div class="metric-card warning">
      <div class="metric-content">
        <div class="metric-icon">
          <i class="fa fa-clock"></i>
        </div>
        <div class="metric-details">
          <h3>{{ pendingInvoices() }}</h3>
          <span>Facturas Pendientes</span>
          <small>{{ todayConsultations() }} consultas hoy</small>
        </div>
      </div>
    </div>

    <!-- Satisfacción -->
    <div class="metric-card purple">
      <div class="metric-content">
        <div class="metric-icon">
          <i class="fa fa-heart"></i>
        </div>
        <div class="metric-details">
          <h3>{{ clientSatisfaction() }}%</h3>
          <span>Satisfacción</span>
          <small>{{ averageConsultationTime() }} min promedio</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <!-- Revenue Chart -->
    <orb-card class="chart-card">
      <div orbHeader>
        <h3><i class="fa fa-chart-line"></i> Evolución de Ingresos</h3>
        <div class="chart-period">
          <orb-button
            label="Actual"
            variant="text"
            size="small"
            [class.active]="currentPeriod() === 'current'"
            (clicked)="currentPeriod.set('current')"
          >
          </orb-button>
          <orb-button
            label="6M"
            variant="text"
            size="small"
            [class.active]="currentPeriod() === '6months'"
            (clicked)="currentPeriod.set('6months')"
          >
          </orb-button>
          <orb-button
            label="1A"
            variant="text"
            size="small"
            [class.active]="currentPeriod() === '1year'"
            (clicked)="currentPeriod.set('1year')"
          >
          </orb-button>
        </div>
      </div>
      <div orbBody>
        <div class="chart-container">
          <orb-chart type="line" [data]="revenueChartData" [options]="chartOptions" [height]="300">
          </orb-chart>
        </div>
      </div>
    </orb-card>

    <!-- Consultations Status Chart -->
    <orb-card class="chart-card">
      <div orbHeader>
        <h3><i class="fa fa-pie-chart"></i> Estado de Consultas</h3>
      </div>
      <div orbBody>
        <div class="chart-container">
          <orb-chart
            type="doughnut"
            [data]="consultationsChartData"
            [options]="doughnutOptions"
            [height]="300"
          >
          </orb-chart>
        </div>
      </div>
    </orb-card>

    <!-- Performance Metrics -->
    <orb-card class="chart-card">
      <div orbHeader>
        <h3><i class="fa fa-chart-bar"></i> Métricas de Rendimiento</h3>
      </div>
      <div orbBody>
        <div class="chart-container">
          <orb-chart type="bar" [data]="performanceChartData" [options]="barOptions" [height]="300">
          </orb-chart>
        </div>
      </div>
    </orb-card>
  </div>

  <!-- Goals & Progress Section -->
  <div class="goals-grid">
    <orb-card class="goal-card">
      <div orbHeader>
        <h3><i class="fa fa-target"></i> Meta Mensual de Ingresos</h3>
      </div>
      <div orbBody>
        <div class="goal-content">
          <div class="goal-amount">
            <span class="current">{{
              totalRevenue() | currency : 'EUR' : 'symbol' : '1.0-0'
            }}</span>
            <span class="target"
              >/ {{ monthlyRevenueGoal() | currency : 'EUR' : 'symbol' : '1.0-0' }}</span
            >
          </div>
          <orb-progress-bar
            [value]="getRevenueProgress()"
            [showValue]="false"
            styleClass="revenue-progress"
          >
          </orb-progress-bar>
          <div class="progress-label">
            {{ getRevenueProgress() | number : '1.0-0' }}% completado
          </div>
        </div>
      </div>
    </orb-card>

    <orb-card class="goal-card">
      <div orbHeader>
        <h3><i class="fa fa-users"></i> Meta de Consultas</h3>
      </div>
      <div orbBody>
        <div class="goal-content">
          <div class="goal-amount">
            <span class="current">{{ totalConsultations() }}</span>
            <span class="target">/ {{ monthlyConsultationsGoal() }}</span>
          </div>
          <orb-progress-bar
            [value]="getConsultationsProgress()"
            [showValue]="false"
            styleClass="consultations-progress"
          >
          </orb-progress-bar>
          <div class="progress-label">
            {{ getConsultationsProgress() | number : '1.0-0' }}% completado
          </div>
        </div>
      </div>
    </orb-card>
  </div>

  <!-- Activity Tables -->
  <div class="activity-grid">
    <!-- Recent Invoices -->
    <orb-card class="activity-card">
      <div orbHeader>
        <h3><i class="fa fa-file-invoice"></i> Facturas Recientes</h3>
        <orb-button label="Ver Todas" size="small" variant="text" (clicked)="navigateToInvoices()">
        </orb-button>
      </div>
      <div orbBody>
        <orb-table
          [value]="recentInvoices()"
          [columns]="invoiceColumns"
          [paginator]="false"
          styleClass="recent-table"
        >
          <ng-template #body let-invoice let-columns="columns">
            <tr>
              <td *ngFor="let col of columns">
                <ng-container [ngSwitch]="col.field">
                  <ng-container *ngSwitchCase="'invoiceNumber'">
                    {{ invoice.invoiceNumber }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'client'">
                    {{ getClientName(invoice) }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'total'">
                    {{ invoice.total | currency : 'EUR' : 'symbol' : '1.2-2' }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'status'">
                    <orb-tag
                      [value]="getStatusLabel(invoice.status)"
                      [severity]="getStatusSeverity(invoice.status)"
                    >
                    </orb-tag>
                  </ng-container>
                </ng-container>
              </td>
            </tr>
          </ng-template>
        </orb-table>
      </div>
    </orb-card>

    <!-- Recent Consultations -->
    <orb-card class="activity-card">
      <div orbHeader>
        <h3><i class="fa fa-stethoscope"></i> Consultas Recientes</h3>
        <orb-button
          label="Ver Todas"
          size="small"
          variant="text"
          (clicked)="navigateToConsultations()"
        >
        </orb-button>
      </div>
      <div orbBody>
        <orb-table
          [value]="recentConsultations()"
          [columns]="consultationColumns"
          [paginator]="false"
          styleClass="recent-table"
        >
          <ng-template #body let-consultation let-columns="columns">
            <tr>
              <td *ngFor="let col of columns">
                <ng-container [ngSwitch]="col.field">
                  <ng-container *ngSwitchCase="'consultationNumber'">
                    {{ consultation.consultationNumber }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'client'">
                    {{ getClientName(consultation) }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'createdAt'">
                    {{ formatDate(consultation.createdAt) }}
                  </ng-container>
                  <ng-container *ngSwitchCase="'status'">
                    <orb-tag
                      [value]="getStatusLabel(consultation.status)"
                      [severity]="getStatusSeverity(consultation.status)"
                    >
                    </orb-tag>
                  </ng-container>
                </ng-container>
              </td>
            </tr>
          </ng-template>
        </orb-table>
      </div>
    </orb-card>
  </div>

  <!-- Quick Actions Panel -->
  <orb-card class="quick-actions-panel">
    <div orbHeader>
      <h3><i class="fa fa-bolt"></i> Acciones Rápidas</h3>
    </div>
    <div orbBody>
      <div class="quick-actions-grid">
        <orb-button
          label="Ver Agenda"
          icon="fa fa-calendar"
          size="large"
          severity="secondary"
          variant="outlined"
          (clicked)="navigateToAgenda()"
        >
        </orb-button>
        <orb-button
          label="Reportes"
          icon="fa fa-chart-line"
          size="large"
          severity="help"
          variant="outlined"
          (clicked)="navigateToInvoices()"
        >
        </orb-button>
      </div>
    </div>
  </orb-card>
</div>

<!-- Loading State -->
<div class="dashboard-loading" *ngIf="isLoading()">
  <div class="loading-content">
    <i class="fa fa-spinner fa-spin"></i>
    <p>Cargando dashboard...</p>
  </div>
</div>
