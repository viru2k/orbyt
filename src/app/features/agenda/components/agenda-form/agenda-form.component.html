<form [formGroup]="agendaForm" (ngSubmit)="onSubmit()">
  <div class="p-fluid grid">
    <!-- 1. Selección de Profesional (primero para habilitar cliente) -->
    <div class="col-12 md:col-6">
      <orb-form-field
        label="Profesional"
        description="Selecciona el profesional que realizará el servicio"
      >
        <orb-select
          formControlName="professionalId"
          [options]="(professionals$ | async) || []"
          optionLabel="fullName"
          optionValue="id"
          [filter]="true"
          filterBy="fullName"
        ></orb-select>
      </orb-form-field>
    </div>
    <!-- Selección de Cliente -->
    <div class="col-12">
      <orb-form-field label="" description="Selecciona el cliente para la cita">
        <div class="client-selector">
          <div *ngIf="selectedClient; else selectClientTemplate" class="selected-client">
            <orb-entity-avatar [entity]="selectedClient" entityType="client" size="normal">
            </orb-entity-avatar>
            <div class="client-info">
              <span class="client-name">{{
                selectedClient.fullname || getClientDisplayName(selectedClient)
              }}</span>
              <div class="client-details">
                <span *ngIf="selectedClient.email" class="detail">{{ selectedClient.email }}</span>
                <span *ngIf="selectedClient.phone" class="detail">{{ selectedClient.phone }}</span>
              </div>
            </div>
            <orb-button
              severity="danger"
              variant="outlined"
              size="small"
              (clicked)="clearClient()"
              tooltip="Cambiar cliente"
            >
              <i class="fa-solid fa-xmark"></i>
            </orb-button>
          </div>
          <ng-template #selectClientTemplate>
            <orb-button
              label="Seleccionar Cliente"
              icon="pi pi-user"
              severity="secondary"
              variant="outlined"
              styleClass="w-full client-select-button"
              (clicked)="openClientSearchModal()"
              [disabled]="!selectedProfessionalId"
            >
            </orb-button>
            <small *ngIf="!selectedProfessionalId" class="help-text">
              Primero selecciona un profesional
            </small>
          </ng-template>
        </div>
      </orb-form-field>
    </div>

    <!-- 2. Selección de Servicio -->
    <div class="col-12">
      <orb-form-field label="" description="Selecciona el servicio que se realizará en la cita">
        <div class="service-selector">
          <div *ngIf="selectedService; else selectServiceTemplate" class="selected-service">
            <div class="service-info">
              <div class="service-name">
                <h5>{{ selectedService.name }}</h5>
                <p-badge
                  *ngIf="selectedService.id && selectedService.id > 1000000000000"
                  value="Personalizado"
                  severity="warn"
                >
                </p-badge>
                <p-badge
                  *ngIf="!selectedService.id || selectedService.id <= 1000000000000"
                  value="Servicio"
                  severity="success"
                >
                </p-badge>
              </div>

              <div class="service-details">
                <span *ngIf="selectedService.description" class="description">
                  {{ selectedService.description }}
                </span>
                <div class="service-meta">
                  <span *ngIf="getServicePrice(selectedService)" class="price">
                    {{ formatPrice(getServicePrice(selectedService)) }}
                  </span>
                  <span *ngIf="selectedService.duration" class="duration">
                    <i class="fa fa-clock"></i>
                    {{ selectedService.duration }} min
                  </span>
                </div>
              </div>
            </div>
            <orb-button
              severity="danger"
              variant="outlined"
              size="small"
              (clicked)="clearService()"
              tooltip="Cambiar servicio"
            >
              <i class="fa-solid fa-xmark"></i>
            </orb-button>
          </div>
          <ng-template #selectServiceTemplate>
            <orb-button
              label="Seleccionar Servicio"
              icon="pi pi-cog"
              severity="secondary"
              styleClass="w-full service-select-button"
              (clicked)="openServiceSearchModal()"
            >
            </orb-button>
          </ng-template>
        </div>
      </orb-form-field>
    </div>

    <!-- 3. Título (auto-completado pero editable) -->
    <div class="col-12">
      <orb-form-field
        label="Título"
        description="Se completa automáticamente al seleccionar cliente y servicio"
      >
        <orb-text-input formControlName="title"></orb-text-input>
      </orb-form-field>
    </div>

    <!-- 4. Descripción -->
    <div class="col-12">
      <orb-form-field label="Notas">
        <orb-text-area formControlName="description" [rows]="3"></orb-text-area>
      </orb-form-field>
    </div>

    <!-- Fechas -->
    <div class="col-12 md:col-6">
      <orb-form-field label="Fecha y Hora de Inicio">
        <orb-datepicker
          formControlName="startDateTime"
          mode="datetime"
          [showIcon]="true"
        ></orb-datepicker>
      </orb-form-field>
    </div>
    <div class="col-12 md:col-6">
      <orb-form-field label="Fecha y Hora de Fin">
        <orb-datepicker
          formControlName="endDateTime"
          mode="datetime"
          [showIcon]="true"
        ></orb-datepicker>
      </orb-form-field>
    </div>

    <!-- Mensaje de disponibilidad de turnos -->
    <div class="col-12" *ngIf="availabilityMessage">
      <p-message
        [severity]="availabilityMessage.severity"
        [text]="availabilityMessage.text"
        [closable]="true"
        (onClose)="clearAvailabilityMessage()"
      ></p-message>
    </div>

    <!-- Otros campos -->
    <div class="col-12 md:col-6">
      <orb-form-field label="Sala">
        <orb-select
          formControlName="roomId"
          [options]="(rooms$ | async) || []"
          optionLabel="name"
          optionValue="id"
        ></orb-select>
      </orb-form-field>
    </div>
    <div class="col-12 md:col-6">
      <orb-form-field label="Estado">
        <orb-select
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
        ></orb-select>
      </orb-form-field>
    </div>
  </div>

  <div class="form-actions">
    <!-- Botones de acciones relacionadas al turno -->
    <div class="actions-row-1" *ngIf="appointment && selectedClient">
            <div class="left-section">
        <orb-button
          *ngIf="appointment"
          label="Eliminar"
          icon="pi pi-trash"
          severity="danger"
          variant="outlined"
          size="small"
          (clicked)="onDelete()"
        ></orb-button>
      </div>
      <orb-button
        label="Consulta"
        icon="pi pi-file-edit"
        severity="info"
        variant="outlined"
        size="small"
        (clicked)="onOpenConsultation()"
        tooltip="Crear consulta para este turno"
      ></orb-button>
      <orb-button
        label="Factura"
        icon="pi pi-receipt"
        severity="success"
        variant="outlined"
        size="small"
        (clicked)="onOpenInvoice()"
        tooltip="Crear factura para este turno"
      ></orb-button>
    </div>

    <!-- Botones principales del formulario -->
    <div class="actions-row-2">


      <div class="right-section">
        <orb-button
          label="Cancelar"
          severity="secondary"
          variant="outlined"
          (clicked)="onCancel()"
        ></orb-button>
        <orb-button
          label="{{ appointment ? 'Actualizar' : 'Guardar' }}"
          severity="info"
          type="submit"
          [loading]="(agendaStore.loading$ | async) || false"
          [disabled]="agendaForm.invalid"
        ></orb-button>
      </div>
    </div>
  </div>
</form>

<!-- Modales -->
<orb-client-search-modal
  [(visible)]="showClientSearchModal"
  [professionalId]="selectedProfessionalId || undefined"
  (clientSelected)="onClientSelected($event)"
  (cancel)="onClientSearchCancel()"
>
</orb-client-search-modal>

<orb-service-search-modal
  [(visible)]="showServiceSearchModal"
  [clientId]="selectedClient?.id"
  (serviceSelected)="onServiceSelected($event)"
  (cancel)="onServiceSearchCancel()"
>
</orb-service-search-modal>

<!-- PrimeNG Components -->
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
