<orb-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  size="xl"
  styleClass="agenda-config-modal"
  (onHide)="onHide()"
>
  <div slot="header">
    <h3>⚙️ Configuración de Agenda</h3>
  </div>
  
  <div slot="content">
    <form [formGroup]="configForm" class="config-form">
      
      <!-- Card: Horario de trabajo -->
      <div class="config-card">
        <div class="card-header">
          <h4><i class="pi pi-clock" style="color: #3b82f6;"></i> Horario de Trabajo</h4>
        </div>
        <div class="card-content">
          <div class="time-inputs">
            <div class="input-group">
              <p-floatLabel>
                <input 
                  pInputText 
                  id="startTime"
                  type="time" 
                  formControlName="startTime"
                  class="w-full"
                />
                <label for="startTime">Hora de inicio</label>
              </p-floatLabel>
            </div>
            
            <div class="input-group">
              <p-floatLabel>
                <input 
                  pInputText 
                  id="endTime"
                  type="time" 
                  formControlName="endTime"
                  class="w-full"
                />
                <label for="endTime">Hora de fin</label>
              </p-floatLabel>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Configuración de turnos -->
      <div class="config-card">
        <div class="card-header">
          <h4><i class="pi pi-stopwatch" style="color: #10b981;"></i> Configuración de Turnos</h4>
        </div>
        <div class="card-content">
          <div class="input-group">
            <p-floatLabel>
              <p-inputNumber 
                id="slotDuration"
                formControlName="slotDuration"
                [min]="15"
                [max]="120"
                suffix=" min"
                styleClass="w-full"
              />
              <label for="slotDuration">Duración de cada turno</label>
            </p-floatLabel>
            <small class="help-text">Entre 15 y 120 minutos</small>
          </div>
        </div>
      </div>

      <!-- Card: Configuraciones adicionales -->
      <div class="config-card">
        <div class="card-header">
          <h4><i class="pi pi-cog" style="color: #f59e0b;"></i> Configuraciones Adicionales</h4>
        </div>
        <div class="card-content">
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="overbooking"
                formControlName="overbookingAllowed"
                class="config-checkbox"
              />
              <label for="overbooking" class="checkbox-label">
                Permitir sobrebooking
              </label>
              <small class="help-text">Permitir más citas de las que el horario normalmente permite</small>
            </div>
            
            <div class="checkbox-item">
              <input
                type="checkbox"
                id="blockedDays"
                formControlName="allowBookingOnBlockedDays"
                class="config-checkbox"
              />
              <label for="blockedDays" class="checkbox-label">
                Permitir reservas en días bloqueados
              </label>
              <small class="help-text">Los clientes pueden reservar en días marcados como feriados</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Días laborales - Now spans 2 columns for better layout -->
      <div class="config-card" style="grid-column: span 2;">
        <div class="card-header">
          <h4><i class="pi pi-calendar" style="color: #8b5cf6;"></i> Días Laborales</h4>
        </div>
        <div class="card-content">
          <div class="working-days">
            <!-- Row 1: Monday and Tuesday -->
            <div class="working-days-row">
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[0].label }}" [formControl]="workingDaysControls[0]"></orb-switch>
              </div>
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[1].label }}" [formControl]="workingDaysControls[1]"></orb-switch>
              </div>
            </div>
            
            <!-- Row 2: Wednesday and Thursday -->
            <div class="working-days-row">
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[2].label }}" [formControl]="workingDaysControls[2]"></orb-switch>
              </div>
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[3].label }}" [formControl]="workingDaysControls[3]"></orb-switch>
              </div>
            </div>
            
            <!-- Row 3: Friday and Saturday -->
            <div class="working-days-row">
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[4].label }}" [formControl]="workingDaysControls[4]"></orb-switch>
              </div>
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[5].label }}" [formControl]="workingDaysControls[5]"></orb-switch>
              </div>
            </div>
            
            <!-- Row 4: Sunday centered -->
            <div class="working-days-row">
              <div class="day-checkbox">
                <orb-switch label="     {{ weekDays[6].label }}" [formControl]="workingDaysControls[6]"></orb-switch>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Días Festivos / Vacaciones -->
      <div class="config-card holidays-card">
        <div class="card-header">
          <h4><i class="pi pi-sun" style="color: #ef4444;"></i> Días Festivos y Vacaciones</h4>
        </div>
        <div class="card-content">
          <div class="holidays-management">
            <!-- Add Holiday Button with spacing -->
            <div class="add-holiday-header" style="margin-bottom: 2rem;">
              <orb-button
                label="Agregar Día Festivo"
                icon="pi pi-plus"
                severity="info"
                size="small"
                (click)="showAddHolidayForm = !showAddHolidayForm"
              />
            </div>

            <!-- Add Holiday Form -->
            <div *ngIf="showAddHolidayForm" class="add-holiday-form" style="margin-bottom: 2rem;">
              <form [formGroup]="holidayForm" class="holiday-form-inline">
                <div class="input-group">
                  <p-floatLabel>
                    <p-calendar 
                      id="holidayDate"
                      formControlName="date"
                      dateFormat="dd/mm/yy"
                      styleClass="w-full"
                    />
                    <label for="holidayDate">Fecha</label>
                  </p-floatLabel>
                </div>
                
                <div class="input-group">
                  <p-floatLabel>
                    <input 
                      pInputText 
                      id="holidayReason"
                      formControlName="reason"
                      class="w-full"
                    />
                    <label for="holidayReason">Descripción (opcional)</label>
                  </p-floatLabel>
                </div>

                <div class="form-actions">
                  <orb-button
                    label="Cancelar"
                    severity="secondary"
                    size="small"
                    (click)="onCancelAddHoliday()"
                  />
                  <orb-button
                    label="Agregar"
                    severity="success"
                    icon="pi pi-plus"
                    size="small"
                    (click)="onAddHoliday()"
                    [loading]="!!(agendaStore.holidaysLoading$ | async)"
                    [disabled]="holidayForm.invalid"
                  />
                </div>
              </form>
            </div>

            <!-- Holidays Table with proper spacing -->
            <div class="holidays-table-container" style="margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
              <p-table 
                [value]="(agendaStore.agendaHolydays$ | async) || []" 
                [loading]="!!(agendaStore.holidaysLoading$ | async)"
                [paginator]="true"
                [rows]="5"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} feriados"
                responsiveLayout="scroll"
                styleClass="p-datatable-striped p-datatable-sm"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th style="width: 30%">Fecha</th>
                    <th style="width: 50%">Descripción</th>
                    <th style="width: 10%"></th>
                  </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-holiday>
                  <tr>
                    <td>
                      <div class="holiday-date-cell">
                        <i class="fas fa-calendar-alt"></i>
                        {{ formatDisplayDate(holiday.date) }}
                      </div>
                    </td>
                    <td>
                      <span class="holiday-description">
                        {{ holiday.description || 'Sin descripción' }}
                      </span>
                    </td>
                    <td>
                      <orb-button
                        icon="pi pi-trash"
                        severity="danger"
                        size="small"
                     
                        pTooltip="Eliminar día festivo"
                        (click)="onDeleteHoliday(holiday)"
                      />
                    </td>
                  </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="text-center p-4">
                      <div class="empty-state">
                        <i class="fas fa-calendar-times text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-0">No hay días festivos configurados</p>
                        <small class="text-gray-500">
                          Usa el botón "Agregar Día Festivo" para crear uno nuevo
                        </small>
                      </div>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>
      </div>

    </form>
  </div>
  
  <div slot="footer">
    <div class="modal-actions">
      <orb-button
        label="Cancelar"
        severity="secondary"
        (click)="onCancel()"
        [disabled]="!!(agendaStore.configLoading$ | async)"
      />
      <orb-button
        label="Guardar Configuración"
        severity="success"
        icon="pi pi-save"
        (click)="onSave()"
        [loading]="!!(agendaStore.configLoading$ | async)"
        [disabled]="configForm.invalid"
      />
    </div>
  </div>
</orb-dialog>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>