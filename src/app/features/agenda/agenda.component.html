<!-- Header unificado como dashboard -->
<orb-main-header
  title="Agenda"
  icon="fa fa-calendar"
  subtitle="Gestión de citas y calendario de profesionales"
>
</orb-main-header>

<!-- Card de filtros horizontal compacto -->
<orb-card class="compact-card">

  <div orbBody>
    <div class="compact-filters-container">
      <!-- Fila única con todos los filtros -->
      <div class="filters-row">
        <!-- Filtro de Profesionales -->
        <div class="filter-item">
          <label class="compact-label">Profesionales</label>
          <orb-multiselect
            [options]="(usersStore.users$ | async) || []"
            optionLabel="fullName"
            [ngModel]="selectedUsers"
            (ngModelChange)="onUsersChange($event)"
            styleClass="compact-multiselect"
            display="chip"
            [maxSelectedLabels]="1"
            [selectedItemsLabel]="'{0} sel.'"
            appendTo="body"
          ></orb-multiselect>
        </div>

        <!-- Filtro de Estados -->
        <div class="filter-item">
          <label class="compact-label">Estados</label>
          <orb-multiselect
            placeholder="Todos"
            [options]="statusOptions"
            optionLabel="label"
            optionValue="value"
            [ngModel]="selectedStatuses"
            (ngModelChange)="onStatusesChange($event)"
            styleClass="compact-multiselect"
            display="chip"
            [maxSelectedLabels]="1"
            [selectedItemsLabel]="'{0} sel.'"
            appendTo="body"
          ></orb-multiselect>
        </div>

        <!-- DateRangePicker -->
        <div class="filter-item filter-date">
          <label class="compact-label">Rango de fechas</label>
          <orb-date-range-picker
            [config]="dateRangePickerConfig"
            [ngModel]="selectedDateRange"
            (dateRangeChange)="onDateRangeChange($event)"
          ></orb-date-range-picker>
        </div>

        <!-- Filtro individual de fecha y hora (para crear cita) -->
        <div class="filter-item">
          <label class="compact-label">Fecha específica</label>
          <orb-datepicker
            mode="datetime"
            [ngModel]="selectedDateFrom"
            (ngModelChange)="onDateFromChange($event)"
            styleClass="compact-datepicker"
            appendTo="body"
          ></orb-datepicker>
        </div>

        <!-- Botones de acción -->
        <div class="filter-actions">
          <orb-button
            icon="fa fa-search"
            label="Buscar"
            (click)="performSearch()"
            size="small"
            [variant]="'outlined'"
            severity="info"
          ></orb-button>
          <orb-button
            icon="fa fa-plus"
            label="Crear Turno"
            severity="success"
            (click)="openNewAppointmentDialog()"
            size="small"
            [variant]="'outlined'"
            styleClass="compact-btn"
          ></orb-button>
        </div>
      </div>
    </div>
  </div>
</orb-card>

<!-- Card del calendario/tabla con estados -->
<orb-card style="margin-top: 8px">

  <div orbBody>
    <!-- Fila con estados y botones de vista -->
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      "
    >
      <!-- Estados del resumen -->
      <div class="summary-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap">
        <ng-container *ngIf="agendaStore.summary$ | async as summary">
          <div *ngFor="let item of summary | keyvalue">
            <ng-container *ngIf="item.key !== 'total' && item.key !== 'byDate'">
              <orb-tag
                [value]="getTranslatedStatus(getKeyAsString(item.key)) + ': ' + item.value"
                [severity]="getStatusSeverity(SUMMARY_KEY_MAP[getKeyAsString(item.key)])"
              ></orb-tag>
            </ng-container>
          </div>
        </ng-container>
      </div>

      <!-- Botones para vista -->
      <div style="display: flex; gap: 0.25rem">
        <orb-button
          [severity]="currentView === 'calendar' ? 'info' : 'secondary'"
          (click)="toggleView('calendar')"
          size="small"
          [variant]="currentView !== 'calendar' ? 'outlined' : 'text'"
        >
          <i class="fa-solid fa-calendar"></i
        ></orb-button>
        <orb-button
          [severity]="currentView === 'table' ? 'info' : 'secondary'"
          (click)="toggleView('table')"
          size="small"
          [variant]="currentView !== 'table' ? 'outlined' : 'text'"
        >
          <i class="fa-solid fa-border-all"></i
        ></orb-button>
      </div>
    </div>

    <!-- Vista Calendario -->
    <div *ngIf="currentView === 'calendar'">
      <orb-modern-calendar
        [events]="(agendaStore.calendarEvents$ | async) || []"
        [slotDuration]="(agendaStore.agendaConfig$ | async)?.slotDurationMinutes || 30"
        [view]="CalendarView.Day"
        [viewDate]="calendarViewDate"
        (viewDateChange)="onCalendarViewDateChange($event)"
        (datesSetRange)="handleDatesSet($event)"
        (eventClick)="handleEventClick($event)"
        (dateSelect)="handleDateSelect($event)"
        (eventDrop)="handleEventDrop($event)"
      ></orb-modern-calendar>
    </div>

    <!-- Vista Tabla -->
    <div *ngIf="currentView === 'table'">
      <orb-table
        [value]="(agendaStore.appointments$ | async) || []"
        [columns]="tableColumns"
        [loading]="(agendaStore.loading$ | async) || false"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
      >
        <ng-template pTemplate="body" let-appointment let-columns="columns">
          <tr>
            <td *ngFor="let col of columns">
              <ng-container [ngSwitch]="col.field">
                <span *ngSwitchCase="'startDateTime'">
                  {{ appointment.start | date : 'dd/MM/yyyy HH:mm' }}
                </span>
                <span *ngSwitchCase="'clientName'">{{ appointment.client?.name || '-' }}</span>
                <span *ngSwitchCase="'professionalName'">{{
                  appointment.professional?.name || '-'
                }}</span>
                <span *ngSwitchCase="'status'">
                  <orb-tag
                    [value]="getSpanishStatusText(appointment.status || 'pending')"
                    [severity]="getStatusSeverity(appointment.status || 'pending')"
                    [outlined]="true"
                  ></orb-tag>
                </span>
                <span *ngSwitchCase="'duration'">{{ getDuration(appointment) }} min</span>
                <span *ngSwitchCase="'title'">{{ appointment.title }}</span>
                <div *ngSwitchCase="'actions'" style="display: flex; gap: 0.5rem">
                  <orb-button
                    title="Editar"
                    size="small"
                    severity="secondary"
                    [variant]="'outlined'"
                    (click)="editAppointment(appointment)"
                  >
                <i class="fa-solid fa-pen"></i></orb-button>
                </div>
                <span *ngSwitchDefault>{{ appointment[col.field] }}</span>
              </ng-container>
            </td>
          </tr>
        </ng-template>
      </orb-table>
    </div>
  </div>
</orb-card>

<orb-dialog
  [(visible)]="displayAgendaForm"
  (onHide)="onFormClose()"
  [header]="selectedAppointment ? 'Editar Turno' : 'Nuevo Turno'"
>
  <app-agenda-form
    *ngIf="displayAgendaForm"
    [appointment]="selectedAppointment"
    [initialDate]="dialogInitialDate"
    (close)="onFormClose()"
    (delete)="handleDelete($event)"
  ></app-agenda-form>
</orb-dialog>

<!-- PrimeNG Components -->
<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
