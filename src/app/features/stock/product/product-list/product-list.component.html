<!-- Header unificado como dashboard -->
<orb-main-header
  title="Gesti칩n de Productos"
  icon="fa fa-box"
  subtitle="Administra tu inventario y cat치logo de productos">
</orb-main-header>

<orb-card>
  <div class="grid" orbBody>
    <orb-table
      [value]="(products$ | async) || []"
      [columns]="tableColumns"
      [loading]="(isLoading$ | async) || false"
      [totalRecords]="(products$ | async)?.length || 0"
      [rows]="tableRows()"
      [first]="tableFirst()"
      [tableFeatures]="tableFeaturesConfig"
      [globalFilterFields]="['name', 'description']"
      [rowActions]="productRowActions"
      [tableHeaderActions]="productTableHeaderActions"
      dataKey="id"
      paginatorPosition="both"
      [rowsPerPageOptions]="[15, 30, 50]"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
    >
      <ng-template pTemplate="body" let-product let-columns="columns">
        <tr>
          <td *ngFor="let col of columns">
            <ng-container [ngSwitch]="col.field">
              
              <!-- Caso para la columna de producto: avatar + nombre solamente -->
              <ng-container *ngSwitchCase="'product'">
                <div class="flex align-items-center gap-3">
                  <orb-entity-avatar
                    [entity]="product"
                    entityType="product"
                    size="normal"
                    shape="square"
                    [showTooltip]="true"
                    context="table"
                    [autoLoad]="true">
                  </orb-entity-avatar>
                  <div class="product-info">
                    <div class="product-name font-medium text-900">{{ product.name }}</div>
                  </div>
                </div>
              </ng-container>

              <!-- Nueva columna de descripci칩n separada -->
              <ng-container *ngSwitchCase="'description'">
                <div class="product-description text-600">
                  {{ product.description || 'Sin descripci칩n' }}
                </div>
              </ng-container>
              
              <ng-container *ngSwitchCase="'currentPrice'">
                {{ product.currentPrice | currency:'EUR' }}
              </ng-container>

              <!-- Caso para la columna de estado: mostramos badge -->
              <ng-container *ngSwitchCase="'statusText'">
                <span [ngClass]="isProductActive(product.status) ? 'status-active' : 'status-inactive'">
                  {{ isProductActive(product.status) ? 'Activo' : 'Inactivo' }}
                </span>
              </ng-container>

              <!-- Columna de propietario simplificada - solo avatar -->
              <ng-container *ngSwitchCase="'ownerName'">
                <div class="owner-avatar-container" *ngIf="product.owner">
                  <orb-entity-avatar
                    [entity]="product.owner"
                    entityType="user"
                    size="normal"
                    shape="circle"
                    [showTooltip]="true"
                    [tooltipText]="product.owner.fullName || 'Propietario no asignado'"
                    [customTooltipText]="true"
                    context="table"
                    [autoLoad]="true">
                  </orb-entity-avatar>
                </div>
                <span *ngIf="!product.owner" class="text-muted">Sin propietario</span>
              </ng-container>

              <ng-container *ngSwitchCase="'actions'">
                <orb-actions-popover
                  [actions]="productRowActions"
                  [itemData]="product">
                </orb-actions-popover>
              </ng-container>

              <ng-container *ngSwitchDefault>
                {{ product[col.field] }}
              </ng-container>
              
            </ng-container>
          </td>
        </tr>
      </ng-template>
    </orb-table>
  </div>
</orb-card>

<orb-dialog
  [visible]="displayProductModal()"
  (visibleChange)="displayProductModal.set($event)"
  [header]="isEditMode() ? 'Editar Producto' : 'Nuevo Producto'"
  size="sm"
  (onHide)="onCancelForm()"
>
  @if (displayProductModal()) {
    <orb-product-form
      [product]="productToEdit() ?? undefined"
      (saved)="onSavedForm()"
      (cancel)="onCancelForm()"
    >
    </orb-product-form>
  }
</orb-dialog>

<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
