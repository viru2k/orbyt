<div class="rooms-container">
  <!-- Breadcrumb superior -->
  <orb-breadcrumb [items]="breadcrumbItems"></orb-breadcrumb>

  <orb-toolbar>
    <div body></div>
    <div footer>
      <orb-button label="Nueva Sala" (click)="onCreateRoom()" />
    </div>
  </orb-toolbar>

  <orb-card>
    <div class="grid" orbBody>

      <!-- Tabla de salas -->
      <orb-table
        [value]="rooms()"
        [columns]="tableColumns"
        [loading]="isLoading()"
        [totalRecords]="rooms().length"
        [rows]="tableRows()"
        [first]="tableFirst()"
        [tableFeatures]="tableFeaturesConfig"
        [globalFilterFields]="['name', 'description', 'location']"
        [rowActions]="roomRowActions"
        dataKey="id"
        paginatorPosition="bottom"
        [rowsPerPageOptions]="[15, 30, 50]"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} salas">
        
        <ng-template pTemplate="body" let-room let-columns="columns">
          <tr>
            <td *ngFor="let col of columns">
              <ng-container [ngSwitch]="col.field">
                
                <!-- Caso para la columna de sala: información -->
                <ng-container *ngSwitchCase="'room'">
                  <div class="room-info">
                    <div class="room-name font-medium text-900">{{ room.name }}</div>
                    <div class="room-description text-600 text-sm">{{ room.description || 'Sin descripción' }}</div>
                  </div>
                </ng-container>
                
                <!-- Caso para la columna de ubicación -->
                <ng-container *ngSwitchCase="'location'">
                  {{ room.location || '-' }}
                </ng-container>
                
                <!-- Caso para la columna de capacidad -->
                <ng-container *ngSwitchCase="'capacity'">
                  <span *ngIf="room.capacity">{{ room.capacity }}</span>
                  <span *ngIf="!room.capacity" class="text-muted">-</span>
                </ng-container>
                
                <!-- Caso para la columna de estado -->
                <ng-container *ngSwitchCase="'statusText'">
                  <span [ngClass]="room.isActive ? 'status-active' : 'status-inactive'">
                    {{ room.isActive ? 'Activo' : 'Inactivo' }}
                  </span>
                </ng-container>
                
                <!-- Caso para la columna de fecha: mostramos el valor formateado -->
                <ng-container *ngSwitchCase="'updatedAt'">
                  {{ formatDate(room.updatedAt) }}
                </ng-container>

                <!-- Caso para la columna de acciones: dibujamos los botones -->
                <ng-container *ngSwitchCase="'actions'">
                  <div class="flex gap-2">
                    <orb-actions-popover
                      [actions]="roomRowActions"
                      [itemData]="room">
                    </orb-actions-popover>
                  </div>
                </ng-container>

                <ng-container *ngSwitchDefault>
                  {{ room[col.field] }}
                </ng-container>
                
              </ng-container>
            </td>
          </tr>
        </ng-template>
      </orb-table>
    </div>
  </orb-card>

  <!-- Modal para crear/editar sala -->
  <orb-dialog
    [visible]="showRoomModal()"
    (visibleChange)="showRoomModal.set($event)"
    [header]="modalTitle"
    size="sm"
    (onHide)="closeModal()">
    
    <form [formGroup]="roomForm" (ngSubmit)="onSaveRoom()">
      <div class="form-content">
        <!-- Nombre -->
        <div class="field">
          <orb-form-field
            label="Nombre de la Sala"
            [required]="true">
            <orb-text-input
              formControlName="name">
            </orb-text-input>
          </orb-form-field>
        </div>

        <!-- Descripción -->
        <div class="field">
          <orb-form-field label="Descripción">
            <textarea
              pInputTextarea
              formControlName="description"
              rows="3"
              class="w-full">
            </textarea>
          </orb-form-field>
        </div>

        <!-- Ubicación y Capacidad en la misma fila -->
        <div class="form-row">
          <div class="field">
            <orb-form-field label="Ubicación">
              <orb-text-input
                formControlName="location">
              </orb-text-input>
            </orb-form-field>
          </div>

          <div class="field">
            <orb-form-field
              label="Capacidad">
              <p-inputNumber
                formControlName="capacity"
                mode="decimal"
                [useGrouping]="false"
                [min]="1"
                [max]="100"
                styleClass="w-full">
              </p-inputNumber>
            </orb-form-field>
          </div>
        </div>

        <!-- Estado -->
        <div class="field">
          <orb-form-field label="Estado" [required]="true">
            <orb-select
              formControlName="isActive"
              [options]="statusOptions"
              optionLabel="label"
              optionValue="value"
              [showClear]="false">
            </orb-select>
          </orb-form-field>
        </div>
      </div>
    </form>

    <!-- Footer con botones -->
    <div orbDialogFooter class="modal-footer">
      <orb-button
        label="Cancelar"
        icon="fas fa-times"
        variant="outline"
        severity="secondary"
        type="button"
        (clicked)="closeModal()">
      </orb-button>

      <orb-button
        [label]="saveButtonText"
        icon="fas fa-save"
        variant="primary"
        severity="primary"
        type="button"
        [disabled]="roomForm.invalid"
        (clicked)="onSaveRoom()">
      </orb-button>
    </div>
  </orb-dialog>

  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
  
  <!-- Toast Messages -->
  <p-toast position="top-right"></p-toast>
</div>